#!/usr/bin/env bash

image_tag="biopod/amber:22.22"

if [ "$1" == "env" ]
then
    echo "Starting ${image_tag} container in current dir -> ${pwd}"
    # --cap-add=SYS_PTRACE for fixing mpi error in docker container running on some machine
    # error looks like: [730d2d54ede3:01733] Read -1, expected 5352, errno = 1
    # discussed at here: https://github.com/open-mpi/ompi/issues/4948
    docker run --ipc=shareable --cap-add=SYS_PTRACE --rm -it --gpus all \
           --mount type=bind,source=$(realpath $(pwd)),target=/mnt \
           --user $(id -u):$(id -g) \
           ${image_tag}
elif [ "$1" == "run" ]
then
    if [ ! -f "$2" ]
    then
        echo "File $2 does not exist."
        exit
    fi
    echo "Amber container started in the background."
    echo "To list the ids or names of the running containers, use:"
    echo "-> docker ps -a"
    echo "To kill a running container, use:"
    echo "-> docker kill CONTAINER_ID or docker kill CONTAINER_NAME"
    docker run --ipc=shareable --cap-add=SYS_PTRACE --rm -itd --gpus all \
           --mount type=bind,source=$(realpath $(pwd)),target=/mnt \
           --user $(id -u):$(id -g) \
           ${image_tag} \
           /bin/bash "$2"
else
    echo "Nothing to do, please use amber env or run."
fi
